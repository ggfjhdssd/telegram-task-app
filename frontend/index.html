<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: radial-gradient(circle at top right, #1a1a2e, #16213e, #0f0c29);
            color: white;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 420px;
            padding: 20px 15px 100px;
        }

        /* Welcome Card */
        .welcome-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px 20px;
            border-radius: 25px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .welcome-card h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .welcome-card p {
            font-size: 18px;
            opacity: 0.9;
        }

        .play-button {
            background: linear-gradient(135deg, #f6d365, #fda085);
            color: #1a1a2e;
            padding: 15px 30px;
            border-radius: 60px;
            font-weight: bold;
            font-size: 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(253, 160, 133, 0.4);
            transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .play-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(253, 160, 133, 0.6);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .username {
            font-size: 14px;
            color: #a0a0a0;
        }

        .coin-balance {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 10px 18px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px #4facfe; }
            100% { box-shadow: 0 0 20px #4facfe; }
        }

        .card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(79,172,254,0.3);
        }

        .flame-icon {
            font-size: 40px;
            animation: burn 1s infinite alternate;
        }

        @keyframes burn {
            0% { filter: drop-shadow(0 0 5px #ff4500); transform: scale(1); }
            100% { filter: drop-shadow(0 0 20px #ffae00); transform: scale(1.1); }
        }

        .coin-icon {
            font-size: 40px;
            animation: sway 2.5s infinite ease-in-out;
        }

        @keyframes sway {
            0% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
            100% { transform: rotate(-10deg); }
        }

        .task-title {
            flex: 1;
            margin-left: 20px;
            font-weight: 600;
        }

        .btn {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            border: none;
            padding: 10px 16px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            min-width: 85px;
            transition: all 0.2s;
        }

        .btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 8px 18px rgba(58,123,213,0.6);
        }

        .btn:disabled {
            background: rgba(255,255,255,0.1);
            color: #888;
            cursor: not-allowed;
        }

        nav {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 380px;
            background: rgba(10,10,25,0.85);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .nav-item {
            text-align: center;
            color: #888;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: #4facfe;
        }

        .nav-item:hover {
            color: #fda085;
            transform: translateY(-2px);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .placeholder {
            text-align: center;
            padding: 50px 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 20px;
            color: #aaa;
        }

        .profile-info {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
        }

        .profile-info p {
            margin: 10px 0;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="profile">
                <div class="avatar">üê±</div>
                <div>
                    <h4>Hello,</h4>
                    <span class="username" id="usernameDisplay">@username</span>
                </div>
            </div>
            <div class="coin-balance">
                <span>ü™ô</span>
                <span id="totalCoins">1,250</span>
            </div>
        </header>

        <!-- Welcome Card (Start Message) -->
        <div class="welcome-card" id="welcomeCard">
            <h1>·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´ üëã</h1>
            <p id="welcomeUsername">@username</p>
            <p>·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·ÄÄ·ÄÖ·Ä¨·Ä∏·Äõ·Äî·Ä∫ ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ Play ·ÄÄ·Ä≠·ÄØ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´</p>
        </div>

        <!-- Play Button (Big) -->
        <div class="play-button" id="playButton">
            üéÆ PLAY GAME
        </div>

        <!-- Home Section -->
        <div id="homeSection" class="section active">
            <div class="card">
                <div class="flame-icon">üî•</div>
                <div class="task-title">Daily Check-in</div>
                <button class="btn" id="dailyBtn">Check-in</button>
            </div>

            <div class="card">
                <div class="coin-icon">ü™ô</div>
                <div class="task-title">Task 1</div>
                <button class="btn task-btn" data-id="task1">Get +30</button>
            </div>
            <div class="card">
                <div class="coin-icon">ü™ô</div>
                <div class="task-title">Task 2</div>
                <button class="btn task-btn" data-id="task2">Get +30</button>
            </div>
            <div class="card">
                <div class="coin-icon">ü™ô</div>
                <div class="task-title">Task 3</div>
                <button class="btn task-btn" data-id="task3">Get +30</button>
            </div>
            <div class="card">
                <div class="coin-icon">ü™ô</div>
                <div class="task-title">Task 4</div>
                <button class="btn task-btn" data-id="task4">Get +30</button>
            </div>
            <div class="card">
                <div class="coin-icon">ü™ô</div>
                <div class="task-title">Task 5</div>
                <button class="btn task-btn" data-id="task5">Get +30</button>
            </div>
        </div>

        <!-- Earn Section -->
        <div id="earnSection" class="section">
            <div class="placeholder">
                <h2>üí∞ Earn Coins</h2>
                <p>Watch ads & complete offers</p>
                <p style="margin-top:20px;">Coming Soon...</p>
            </div>
        </div>

        <!-- Games Section -->
        <div id="gamesSection" class="section">
            <div class="placeholder">
                <h2>üéÆ Play Games</h2>
                <p>Earn while having fun</p>
                <p style="margin-top:20px;">Coming Soon...</p>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="section">
            <div class="profile-info">
                <div class="avatar" style="width:80px; height:80px; font-size:48px; margin:0 auto 20px;">üê±</div>
                <p><strong>Username:</strong> <span id="profileUsername">@username</span></p>
                <p><strong>Coins:</strong> <span id="profileCoins">1,250</span></p>
                <p><strong>Member Since:</strong> 2026</p>
            </div>
        </div>

        <!-- Navigation -->
        <nav>
            <div class="nav-item active" data-tab="home"><div class="nav-icon">üè†</div>Home</div>
            <div class="nav-item" data-tab="earn"><div class="nav-icon">üí∞</div>Earn</div>
            <div class="nav-item" data-tab="games"><div class="nav-icon">üéÆ</div>Games</div>
            <div class="nav-item" data-tab="profile"><div class="nav-icon">üë§</div>Profile</div>
        </nav>
    </div>

    <script>
        // ==================== Configuration ====================
        const API_BASE = 'https://telegram-task-app-coik.onrender.com'; 
        const tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.expand();
            tg.ready();
        }

        const initData = tg?.initData || '';

        // DOM Elements
        const usernameSpan = document.getElementById('usernameDisplay');
        const profileUsername = document.getElementById('profileUsername');
        const welcomeUsername = document.getElementById('welcomeUsername');
        const totalCoinsSpan = document.getElementById('totalCoins');
        const profileCoinsSpan = document.getElementById('profileCoins');
        const dailyBtn = document.getElementById('dailyBtn');
        const taskBtns = document.querySelectorAll('.task-btn');
        const playButton = document.getElementById('playButton');

        // ==================== Play Button Click ====================
        playButton.addEventListener('click', () => {
            alert('üéÆ Game coming soon! ·Äô·ÄÄ·Äº·Ä¨·ÄÅ·ÄÑ·Ä∫ ·Äú·Ä¨·Äï·Ä´·Äô·Äö·Ä∫·Åã');
        });

        // ==================== Helper Functions ====================
        function formatTime(ms) {
            if (ms < 0) ms = 0;
            const sec = Math.floor(ms / 1000);
            const h = Math.floor(sec / 3600).toString().padStart(2, '0');
            const m = Math.floor((sec % 3600) / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // Update UI with user data from server
        function updateUI(data) {
            const displayName = data.username ? '@' + data.username : 'User';
            usernameSpan.innerText = displayName;
            profileUsername.innerText = displayName;
            welcomeUsername.innerText = displayName;

            totalCoinsSpan.innerText = data.coins.toLocaleString();
            profileCoinsSpan.innerText = data.coins.toLocaleString();

            const now = Date.now();
            const dailyLast = data.dailyLastClaim || 0;
            const dailyRemaining = (24 * 60 * 60 * 1000) - (now - dailyLast);

            if (dailyRemaining > 0 && dailyLast !== 0) {
                dailyBtn.disabled = true;
                dailyBtn.innerText = formatTime(dailyRemaining);
            } else {
                dailyBtn.disabled = false;
                dailyBtn.innerText = 'Check-in';
            }

            taskBtns.forEach(btn => {
                const taskId = btn.dataset.id;
                const last = data.tasks?.[taskId] || 0;
                const remaining = (2 * 60 * 60 * 1000) - (now - last);

                if (remaining > 0 && last !== 0) {
                    btn.disabled = true;
                    btn.innerText = formatTime(remaining);
                } else {
                    btn.disabled = false;
                    btn.innerText = 'Get +30';
                }
            });
        }

        // Fetch user data from backend
        async function fetchUser() {
            try {
                const res = await fetch(`${API_BASE}/api/user`, {
                    headers: { 'X-Telegram-Init-Data': initData }
                });
                const data = await res.json();
                if (res.ok) {
                    updateUI(data);
                    startLocalTimers(data);
                }
            } catch (err) {
                console.error('Fetch user error:', err);
            }
        }

        // Start local countdowns
        function startLocalTimers(data) {
            const now = Date.now();
            const dailyLast = data.dailyLastClaim || 0;
            const dailyRemaining = (24 * 60 * 60 * 1000) - (now - dailyLast);

            if (dailyRemaining > 0 && dailyLast !== 0) {
                const updateDaily = () => {
                    const remaining = (24 * 60 * 60 * 1000) - (Date.now() - dailyLast);
                    if (remaining <= 0) {
                        dailyBtn.disabled = false;
                        dailyBtn.innerText = 'Check-in';
                    } else {
                        dailyBtn.disabled = true;
                        dailyBtn.innerText = formatTime(remaining);
                        setTimeout(updateDaily, 1000);
                    }
                };
                updateDaily();
            }

            taskBtns.forEach(btn => {
                const taskId = btn.dataset.id;
                const last = data.tasks?.[taskId] || 0;
                const remaining = (2 * 60 * 60 * 1000) - (now - last);

                if (remaining > 0 && last !== 0) {
                    const updateTask = () => {
                        const remaining = (2 * 60 * 60 * 1000) - (Date.now() - last);
                        if (remaining <= 0) {
                            btn.disabled = false;
                            btn.innerText = 'Get +30';
                        } else {
                            btn.disabled = true;
                            btn.innerText = formatTime(remaining);
                            setTimeout(updateTask, 1000);
                        }
                    };
                    updateTask();
                }
            });
        }

        // Daily claim
        dailyBtn.addEventListener('click', async () => {
            if (dailyBtn.disabled) return;
            try {
                const res = await fetch(`${API_BASE}/api/claim/daily`, {
                    method: 'POST',
                    headers: { 'X-Telegram-Init-Data': initData }
                });
                const data = await res.json();
                if (res.ok) {
                    fetchUser(); // refresh all
                } else {
                    alert(data.error || 'Claim failed');
                }
            } catch (err) {
                console.error('Daily claim error:', err);
            }
        });

        // Task claim
        taskBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                if (btn.disabled) return;
                const taskId = btn.dataset.id;
                try {
                    const res = await fetch(`${API_BASE}/api/claim/task/${taskId}`, {
                        method: 'POST',
                        headers: { 'X-Telegram-Init-Data': initData }
                    });
                    const data = await res.json();
                    if (res.ok) {
                        fetchUser();
                    } else {
                        alert(data.error || 'Claim failed');
                    }
                } catch (err) {
                    console.error('Task claim error:', err);
                }
            });
        });

        // Tab Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const sections = {
            home: document.getElementById('homeSection'),
            earn: document.getElementById('earnSection'),
            games: document.getElementById('gamesSection'),
            profile: document.getElementById('profileSection')
        };

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(n => n.classList.remove('active'));
                item.classList.add('active');

                Object.values(sections).forEach(s => s.classList.remove('active'));
                const tab = item.dataset.tab;
                if (sections[tab]) sections[tab].classList.add('active');
            });
        });

        // Start
        fetchUser();
    </script>
</body>
</html>
